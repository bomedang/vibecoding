<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>YouTube 리듬게임 (데모)</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --accent: #8b5cf6;
            --accent2: #ec4899;
            --white: #f8fafc
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(135deg, #0f172a, #0b1220);
            color: var(--white)
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0
        }

        .logo {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .nav button {
            margin-right: 8px;
            background: transparent;
            border: 0;
            color: #cbd5e1;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer
        }

        .nav button.active {
            background: rgba(255, 255, 255, 0.06);
            color: var(--white)
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04)
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px
        }

        .btn {
            background: linear-gradient(90deg, var(--accent2), var(--accent));
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            border: 0;
            cursor: pointer
        }

        .muted {
            color: #9ca3af
        }

        .lanes {
            display: flex;
            gap: 12px;
            justify-content: center
        }

        .lane {
            width: 110px;
            height: 520px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.03)
        }

        .hitline {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 80px;
            height: 6px;
            background: linear-gradient(90deg, #34d399, #60a5fa);
            box-shadow: 0 4px 14px rgba(96, 165, 250, 0.12)
        }

        .note {
            position: absolute;
            left: 8px;
            right: 8px;
            height: 48px;
            border-radius: 8px;
            background: linear-gradient(180deg, #fb7185, #8b5cf6);
            box-shadow: 0 6px 12px rgba(139, 92, 246, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700
        }

        .keycap {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 8px;
            text-align: center;
            color: #fff
        }

        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.9);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .modal {
            background: #071032;
            padding: 20px;
            border-radius: 12px;
            color: #fff;
            max-width: 420px;
            width: 100%
        }

        input[type=text] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--white)
        }

        .thumbnail {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 8px
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(90deg,#ec4899,#8b5cf6)">
                </div>
                <div>
                    <div style="font-weight:700">YouTube 리듬게임</div>
                    <div class="muted" style="font-size:12px">데모 — 로컬에서 실행</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
                <nav class="nav">
                    <button id="nav-home" class="active">홈</button>
                    <button id="nav-upload">업로드</button>
                    <button id="nav-community">커뮤니티</button>
                </nav>
                <div id="userArea" style="display:flex;align-items:center;gap:8px">
                    <img id="avatar" src="" alt="" style="width:36px;height:36px;border-radius:999px;display:none">
                    <div id="username" class="muted"></div>
                    <button id="btnLogin" class="btn">로그인</button>
                </div>
            </div>
        </header>

        <main id="app">
            <!-- Home -->
            <section id="page-home">
                <div class="card" style="text-align:center;padding:40px">
                    <h1 style="margin:0 0 12px">YouTube 리듬게임</h1>
                    <p class="muted">YouTube 링크로 박자를 자동 생성해 플레이할 수 있는 데모입니다.</p>
                    <div style="margin-top:18px">
                        <button id="gotoUpload" class="btn">노래 업로드하기</button>
                        <button id="gotoCommunity" style="margin-left:8px" class="btn">곡 둘러보기</button>
                    </div>
                </div>
            </section>

            <!-- Upload -->
            <section id="page-upload" style="display:none">
                <div class="card">
                    <h2>유튜브 링크 업로드</h2>
                    <div style="margin-top:8px">
                        <label class="muted">YouTube URL</label>
                        <input id="inputUrl" type="text" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    <div style="margin-top:12px;display:flex;gap:8px">
                        <button id="btnAnalyze" class="btn">분석 및 업로드</button>
                        <div id="analyzing" class="muted" style="align-self:center;display:none">분석 중...</div>
                    </div>
                    <p class="muted" style="margin-top:10px">자동 박자 생성(모의). 실제 분석은 서버 또는 라이브러리를 사용하세요.</p>
                </div>
            </section>

            <!-- Community -->
            <section id="page-community" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2>커뮤니티 곡</h2>
                </div>
                <div id="songs" class="grid"></div>
            </section>

            <!-- Playing area (overlay) -->
            <div id="playArea" style="display:none;margin-top:12px">
                <div class="card">
                    <div class="hud">
                        <div>
                            <div style="font-weight:700">점수: <span id="score">0</span></div>
                            <div class="muted" id="songTitle"></div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:20px;color:#facc15">콤보 x<span id="combo">0</span></div>
                            <button id="btnEnd" style="margin-top:8px" class="btn">종료</button>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:center;padding:10px">
                        <div class="lanes" id="lanes"></div>
                    </div>
                    <div style="text-align:center;margin-top:12px" class="muted">D F J K 키로 노트를 칩니다.</div>
                </div>
            </div>
        </main>
    </div>

    <!-- YouTube player container (hidden) -->
    <div id="youtube-player" style="display:none"></div>

    <div id="modal" style="display:none" class="overlay">
        <div class="modal">
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // 기본 상태
        const STORAGE_SONGS = 'demo_rhythm_songs_v1';
        let user = null;
        let songs = JSON.parse(localStorage.getItem(STORAGE_SONGS) || '[]');
        let current = null;
        let notes = [];
        let raf = null;
        let startTime = null;
        let score = 0, combo = 0;

        const $ = (id) => document.getElementById(id);

        // UI 참조
        const navHome = $('nav-home');
        const navUpload = $('nav-upload');
        const navCommunity = $('nav-community');
        const pageHome = $('page-home');
        const pageUpload = $('page-upload');
        const pageCommunity = $('page-community');
        const songsEl = $('songs');
        const inputUrl = $('inputUrl');
        const btnAnalyze = $('btnAnalyze');
        const analyzing = $('analyzing');
        const btnLogin = $('btnLogin');
        const avatar = $('avatar');
        const username = $('username');
        const gotoUpload = $('gotoUpload');
        const gotoCommunity = $('gotoCommunity');
        const playArea = $('playArea');
        const lanesEl = $('lanes');
        const songTitle = $('songTitle');
        const scoreEl = $('score');
        const comboEl = $('combo');
        const btnEnd = $('btnEnd');

        // 내비게이션
        function show(page) {
            pageHome.style.display = page === 'home' ? 'block' : 'none';
            pageUpload.style.display = page === 'upload' ? 'block' : 'none';
            pageCommunity.style.display = page === 'community' ? 'block' : 'none';
            [navHome, navUpload, navCommunity].forEach(n => n.classList.remove('active'));
            if (page === 'home') navHome.classList.add('active');
            if (page === 'upload') navUpload.classList.add('active');
            if (page === 'community') navCommunity.classList.add('active');
        }

        navHome.addEventListener('click', () => show('home'));
        navUpload.addEventListener('click', () => show('upload'));
        navCommunity.addEventListener('click', () => { show('community'); renderSongs(); });
        gotoUpload.addEventListener('click', () => show('upload'));
        gotoCommunity.addEventListener('click', () => { show('community'); renderSongs(); });

        // 간단 로그인 (모의)
        btnLogin.addEventListener('click', () => {
            if (!user) {
                user = { id: 'u' + Date.now(), name: '플레이어' + Math.floor(Math.random() * 1000), avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + Date.now() };
                avatar.src = user.avatar; avatar.style.display = 'inline-block'; username.textContent = user.name; btnLogin.textContent = '로그아웃';
            } else {
                user = null; avatar.style.display = 'none'; username.textContent = ''; btnLogin.textContent = '로그인';
            }
        });

        // 업로드 처리: URL에서 비디오 ID 추출
        function extractVideoId(url) {
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtu')) {
                    if (u.searchParams.get('v')) return u.searchParams.get('v');
                    const p = u.pathname.split('/'); return p.pop();
                }
            } catch (e) { }
            const m = url.match(/([a-zA-Z0-9_-]{11})/); return m ? m[1] : null;
        }

        // 모의 박자 분석
        function analyzeBeat(videoId) {
            analyzing.style.display = 'inline-block';
            return new Promise(resolve => {
                setTimeout(() => {
                    const generated = []; const bpm = 100 + Math.floor(Math.random() * 80); const interval = 60 / bpm;
                    const duration = 90; // 초
                    for (let t = 1; t < duration; t += interval) {
                        const lane = Math.floor(Math.random() * 4);
                        generated.push({ time: t, lane, hit: false });
                    }
                    analyzing.style.display = 'none';
                    resolve(generated);
                }, 1400);
            });
        }

        btnAnalyze.addEventListener('click', async () => {
            const url = inputUrl.value.trim(); if (!url) { alert('URL을 입력하세요'); return }
            const vid = extractVideoId(url); if (!vid) { alert('유효한 YouTube URL이 아닙니다'); return }
            const notesData = await analyzeBeat(vid);
            const song = { id: 's' + Date.now(), videoId: vid, title: '곡 ' + (songs.length + 1), uploader: user ? user.name : '익명', notes: notesData, plays: 0, bestScore: 0 };
            songs.push(song); localStorage.setItem(STORAGE_SONGS, JSON.stringify(songs)); inputUrl.value = ''; show('community'); renderSongs();
        });

        function renderSongs() {
            songs = JSON.parse(localStorage.getItem(STORAGE_SONGS) || '[]');
            songsEl.innerHTML = '';
            if (songs.length === 0) { songsEl.innerHTML = '<div class="card">아직 업로드된 곡이 없습니다.</div>'; return }
            songs.forEach(s => {
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `<img class="thumbnail" src="https://img.youtube.com/vi/${s.videoId}/mqdefault.jpg" onerror="this.src='https://via.placeholder.com/320x180'" /><div style='margin-top:8px'><strong>${s.title}</strong><div class=muted style='font-size:12px'>업로드: ${s.uploader}</div></div><div style='margin-top:8px;display:flex;gap:6px'><button class='btn playBtn'>플레이</button></div>`;
                div.querySelector('.playBtn').addEventListener('click', () => startGame(s));
                songsEl.appendChild(div);
            });
        }

        // 게임 시작
        function startGame(song) {
            current = song; notes = song.notes.map(n => Object.assign({}, n)); score = 0; combo = 0; startTime = null; updateHUD();
            songTitle.textContent = song.title; playArea.style.display = 'block'; renderLanes();
            // 로드 YouTube는 선택 사항 — 이 데모는 시간 기준으로 노트를 진행
            if (window.YT && window.YT.Player) { /* optional: play video */ }
            raf = requestAnimationFrame(loop);
        }

        function renderLanes() {
            lanesEl.innerHTML = ''; for (let i = 0; i < 4; i++) {
                const lane = document.createElement('div'); lane.className = 'lane'; lane.dataset.lane = i;
                lane.innerHTML = `<div class='hitline'></div><div class='keycap'>${['D', 'F', 'J', 'K'][i]}</div>`;
                lanesEl.appendChild(lane);
            }
        }

        function loop() {
            if (!startTime) startTime = Date.now();
            const t = (Date.now() - startTime) / 1000;
            // 노트 렌더
            for (const laneEl of lanesEl.children) { laneEl.querySelectorAll('.note').forEach(n => n.remove()); }
            notes.forEach((note, idx) => {
                const laneEl = lanesEl.children[note.lane];
                const progress = ((note.time - t));
                const bottomPercent = Math.max(-20, Math.min(120, 100 - progress * 40));
                if (!note.hit && bottomPercent < 120) {
                    const d = document.createElement('div'); d.className = 'note'; d.style.bottom = bottomPercent + '%'; d.textContent = ''; laneEl.appendChild(d);
                }
            });

            // 끝난 노트 제거
            notes = notes.filter(n => !(n.time < t - 0.5 && !n.hit));

            // 게임 종료 조건
            if (notes.length === 0 && startTime && !notes.some(n => !n.hit)) {
                endGame(); return;
            }

            raf = requestAnimationFrame(loop);
        }

        // 키 입력
        window.addEventListener('keydown', (e) => {
            if (!current) return;
            const map = { d: 0, f: 1, j: 2, k: 3 }; const key = e.key.toLowerCase(); if (!(key in map)) return;
            const lane = map[key]; const t = (Date.now() - startTime) / 1000;
            // 가장 가까운 노트 판정
            let hitIdx = -1; let bestDiff = 1;
            for (let i = 0; i < notes.length; i++) { const n = notes[i]; if (n.lane !== lane || n.hit) continue; const diff = Math.abs(t - n.time); if (diff < 0.18 && diff < bestDiff) { bestDiff = diff; hitIdx = i; } }
            if (hitIdx >= 0) { const n = notes[hitIdx]; n.hit = true; const acc = Math.abs(t - n.time); let pts = 50; if (acc < 0.06) pts = 300; else if (acc < 0.12) pts = 100; score += pts * (combo + 1); combo++; updateHUD(); }
            else { combo = 0; updateHUD(); }
        });

        function updateHUD() { scoreEl.textContent = Math.max(0, score); comboEl.textContent = combo; }

        function endGame() {
            cancelAnimationFrame(raf); playArea.style.display = 'none';
            if (current) { current.plays = (current.plays || 0) + 1; if (score > (current.bestScore || 0)) current.bestScore = score; localStorage.setItem(STORAGE_SONGS, JSON.stringify(songs)); }
            current = null; notes = []; startTime = null; showModal(`<h3>게임 종료</h3><p>점수: <strong>${score}</strong></p><div style='margin-top:12px'><button id='replay' class='btn'>다시하기</button> <button id='closeModal' style='margin-left:8px' class='btn'>확인</button></div>`);
            document.getElementById('replay').addEventListener('click', () => { closeModal(); if (songs.length) startGame(songs[songs.length - 1]); });
            document.getElementById('closeModal').addEventListener('click', () => { closeModal(); renderSongs(); show('community'); });
        }

        btnEnd.addEventListener('click', () => { if (confirm('게임을 종료하시겠습니까?')) endGame(); });

        // 모달
        function showModal(html) { $('modal').style.display = 'flex'; $('modalContent').innerHTML = html; }
        function closeModal() { $('modal').style.display = 'none'; $('modalContent').innerHTML = ''; }

        // 초기 렌더
        renderSongs();

        // YouTube iframe API 로드(선택)
        (function () { var tag = document.createElement('script'); tag.src = 'https://www.youtube.com/iframe_api'; document.head.appendChild(tag); })();
    </script>
</body>

</html>
