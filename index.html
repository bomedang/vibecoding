import React, { useState, useEffect } from 'react';
import { Sword, Shield, Zap, Heart, Crown, TrendingUp, Award, Star, Settings, ChevronRight } from 'lucide-react';

export default function GodKnightIdle() {
  const [knight, setKnight] = useState({
    level: 1,
    exp: 0,
    expToNext: 100,
    gold: 0,
    damage: 10,
    hp: 100,
    maxHp: 100,
    critChance: 5,
    critDamage: 150
  });

  const [currentStage, setCurrentStage] = useState(1);
  const [monster, setMonster] = useState(null);
  const [battleLog, setBattleLog] = useState([]);
  const [autoProgress, setAutoProgress] = useState(true);

  const [upgrades, setUpgrades] = useState({
    weapon: { level: 1, cost: 50, multiplier: 1.5 },
    armor: { level: 1, cost: 50, multiplier: 1.3 },
    crit: { level: 0, cost: 100, multiplier: 1.2 },
    blessing: { level: 0, cost: 200, multiplier: 2 }
  });

  const [skills, setSkills] = useState({
    holyStrike: { level: 0, cost: 150, damage: 50, cooldown: 0, maxCooldown: 5 },
    divineShield: { level: 0, cost: 150, reduction: 20, cooldown: 0, maxCooldown: 8 },
    lightningBolt: { level: 0, cost: 300, damage: 100, cooldown: 0, maxCooldown: 10 }
  });

  const [achievements, setAchievements] = useState([
    { id: 'first_kill', name: 'Ï≤´ ÏäπÎ¶¨', desc: 'Ï≤´ Î™¨Ïä§ÌÑ∞ Ï≤òÏπò', completed: false, reward: 100 },
    { id: 'stage_10', name: 'ÏàôÎ†®Îêú Í∏∞ÏÇ¨', desc: '10Ïä§ÌÖåÏù¥ÏßÄ ÎèÑÎã¨', completed: false, reward: 500 },
    { id: 'level_10', name: 'Ïã†Ïùò Ï∂ïÎ≥µ', desc: 'Î†àÎ≤® 10 Îã¨ÏÑ±', completed: false, reward: 1000 }
  ]);

  const [stats, setStats] = useState({
    totalKills: 0,
    totalGold: 0,
    highestStage: 1,
    playTime: 0
  });

  const [activeTab, setActiveTab] = useState('battle');

  const generateMonster = (stage) => {
    const baseHp = 50 + stage * 30;
    const baseDamage = 5 + stage * 3;
    return {
      name: stage % 10 === 0 ? `Î≥¥Ïä§ ${Math.floor(stage / 10)}` : `ÏïÖÎßà ${stage}`,
      hp: baseHp,
      maxHp: baseHp,
      damage: baseDamage,
      goldReward: 10 + stage * 5,
      expReward: 20 + stage * 10,
      isBoss: stage % 10 === 0
    };
  };

  useEffect(() => {
    if (!monster) {
      setMonster(generateMonster(currentStage));
    }
  }, [currentStage]);

  useEffect(() => {
    const battleInterval = setInterval(() => {
      if (!monster) return;

      setMonster(prev => {
        if (!prev) return prev;
        
        const newMonsterHp = prev.hp - calculateDamage();
        
        if (newMonsterHp <= 0) {
          handleMonsterDefeat(prev);
          return null;
        }

        const newKnightHp = knight.hp - prev.damage;
        if (newKnightHp <= 0) {
          addLog('üíÄ Ìå®Î∞∞ÌñàÏäµÎãàÎã§! Ï≤¥Î†• ÌöåÎ≥µ Ï§ë...');
          setKnight(k => ({ ...k, hp: k.maxHp }));
        } else {
          setKnight(k => ({ ...k, hp: newKnightHp }));
        }

        return { ...prev, hp: newMonsterHp };
      });

      setSkills(s => ({
        holyStrike: { ...s.holyStrike, cooldown: Math.max(0, s.holyStrike.cooldown - 1) },
        divineShield: { ...s.divineShield, cooldown: Math.max(0, s.divineShield.cooldown - 1) },
        lightningBolt: { ...s.lightningBolt, cooldown: Math.max(0, s.lightningBolt.cooldown - 1) }
      }));
    }, 1000);

    return () => clearInterval(battleInterval);
  }, [monster, knight, skills]);

  useEffect(() => {
    const timer = setInterval(() => {
      setStats(s => ({ ...s, playTime: s.playTime + 1 }));
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  const calculateDamage = () => {
    const baseDamage = knight.damage;
    const isCrit = Math.random() * 100 < knight.critChance;
    return isCrit ? Math.floor(baseDamage * (knight.critDamage / 100)) : baseDamage;
  };

  const handleMonsterDefeat = (defeatedMonster) => {
    const goldGained = defeatedMonster.goldReward;
    const expGained = defeatedMonster.expReward;
    
    setKnight(k => {
      const newExp = k.exp + expGained;
      const newGold = k.gold + goldGained;
      
      if (newExp >= k.expToNext) {
        addLog(`‚≠ê Î†àÎ≤® ÏóÖ! Lv.${k.level + 1}`);
        return {
          ...k,
          level: k.level + 1,
          exp: newExp - k.expToNext,
          expToNext: Math.floor(k.expToNext * 1.5),
          gold: newGold,
          damage: k.damage + 5,
          maxHp: k.maxHp + 20,
          hp: k.maxHp + 20
        };
      }
      
      return { ...k, exp: newExp, gold: newGold };
    });

    setStats(s => ({
      ...s,
      totalKills: s.totalKills + 1,
      totalGold: s.totalGold + goldGained,
      highestStage: Math.max(s.highestStage, currentStage)
    }));

    checkAchievements();
    
    if (defeatedMonster.isBoss) {
      addLog(`üëë Î≥¥Ïä§ Ï≤òÏπò! +${goldGained} Í≥®Îìú`);
    }

    if (autoProgress) {
      setCurrentStage(c => c + 1);
    } else {
      addLog(`‚úÖ ÏäπÎ¶¨! Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî.`);
    }
  };

  const checkAchievements = () => {
    setAchievements(prev => prev.map(ach => {
      if (ach.completed) return ach;
      
      let complete = false;
      if (ach.id === 'first_kill' && stats.totalKills >= 0) complete = true;
      if (ach.id === 'stage_10' && currentStage >= 10) complete = true;
      if (ach.id === 'level_10' && knight.level >= 10) complete = true;
      
      if (complete) {
        addLog(`üèÜ ÏóÖÏ†Å Îã¨ÏÑ±: ${ach.name}! +${ach.reward} Í≥®Îìú`);
        setKnight(k => ({ ...k, gold: k.gold + ach.reward }));
        return { ...ach, completed: true };
      }
      return ach;
    }));
  };

  const addLog = (message) => {
    setBattleLog(prev => [message, ...prev.slice(0, 4)]);
  };

  const buyUpgrade = (type) => {
    const upgrade = upgrades[type];
    if (knight.gold < upgrade.cost) return;

    setKnight(k => ({ ...k, gold: k.gold - upgrade.cost }));
    setUpgrades(u => ({
      ...u,
      [type]: {
        ...u[type],
        level: u[type].level + 1,
        cost: Math.floor(u[type].cost * 1.5)
      }
    }));

    if (type === 'weapon') {
      setKnight(k => ({ ...k, damage: Math.floor(k.damage * upgrade.multiplier) }));
    } else if (type === 'armor') {
      setKnight(k => ({ ...k, maxHp: Math.floor(k.maxHp * upgrade.multiplier), hp: Math.floor(k.maxHp * upgrade.multiplier) }));
    } else if (type === 'crit') {
      setKnight(k => ({ ...k, critChance: k.critChance + 5 }));
    } else if (type === 'blessing') {
      setKnight(k => ({ ...k, damage: Math.floor(k.damage * upgrade.multiplier) }));
    }

    addLog(`üîº ${type} ÏóÖÍ∑∏Î†àÏù¥Îìú ÏôÑÎ£å!`);
  };

  const buySkill = (type) => {
    const skill = skills[type];
    if (knight.gold < skill.cost) return;

    setKnight(k => ({ ...k, gold: k.gold - skill.cost }));
    setSkills(s => ({
      ...s,
      [type]: {
        ...s[type],
        level: s[type].level + 1,
        cost: Math.floor(s[type].cost * 1.8)
      }
    }));

    addLog(`‚ö° ${type} Ïä§ÌÇ¨ Í∞ïÌôî!`);
  };

  const useSkill = (type) => {
    const skill = skills[type];
    if (skill.level === 0 || skill.cooldown > 0 || !monster) return;

    if (type === 'holyStrike') {
      const damage = skill.damage * (1 + skill.level * 0.5);
      setMonster(m => m ? { ...m, hp: Math.max(0, m.hp - damage) } : null);
      addLog(`‚öîÔ∏è Ïã†ÏÑ±Ìïú ÏùºÍ≤©! ${Math.floor(damage)} ÌîºÌï¥`);
    } else if (type === 'divineShield') {
      const heal = skill.reduction * (1 + skill.level);
      setKnight(k => ({ ...k, hp: Math.min(k.maxHp, k.hp + heal) }));
      addLog(`üõ°Ô∏è Ïã†ÏÑ±Ìïú Î∞©Ìå®! ${heal} ÌöåÎ≥µ`);
    } else if (type === 'lightningBolt') {
      const damage = skill.damage * (1 + skill.level * 0.7);
      setMonster(m => m ? { ...m, hp: Math.max(0, m.hp - damage) } : null);
      addLog(`‚ö° Ï≤úÎ≤åÏùò Î≤àÍ∞ú! ${Math.floor(damage)} ÌîºÌï¥`);
    }

    setSkills(s => ({
      ...s,
      [type]: { ...s[type], cooldown: s[type].maxCooldown }
    }));
  };

  return (
    <div className="w-full h-screen bg-slate-900 text-white overflow-hidden flex flex-col">
      {/* Header */}
      <div className="bg-slate-800 border-b-2 border-amber-500 px-6 py-4">
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-3">
            <Crown className="text-amber-400" size={32} />
            <div>
              <h1 className="text-2xl font-bold text-amber-400">GOD KNIGHT</h1>
              <p className="text-sm text-slate-400">Ïã†ÏÑ±Ìïú Í∏∞ÏÇ¨Ïùò Ïó¨Ï†ï</p>
            </div>
          </div>
          <div className="flex gap-6 items-center">
            <div className="text-right">
              <div className="text-xs text-slate-400">Î†àÎ≤®</div>
              <div className="text-xl font-bold text-amber-400">{knight.level}</div>
            </div>
            <div className="text-right">
              <div className="text-xs text-slate-400">Í≥®Îìú</div>
              <div className="text-xl font-bold text-yellow-400">{knight.gold}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="bg-slate-800 border-b border-slate-700 px-6">
        <div className="flex gap-1">
          {['battle', 'upgrade', 'skills', 'stats'].map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-6 py-3 font-semibold transition-colors ${
                activeTab === tab
                  ? 'bg-slate-700 text-amber-400 border-b-2 border-amber-400'
                  : 'text-slate-400 hover:text-white hover:bg-slate-750'
              }`}
            >
              {tab === 'battle' && '‚öîÔ∏è Ï†ÑÌà¨'}
              {tab === 'upgrade' && 'üîº Í∞ïÌôî'}
              {tab === 'skills' && '‚ö° Ïä§ÌÇ¨'}
              {tab === 'stats' && 'üìä ÌÜµÍ≥Ñ'}
            </button>
          ))}
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 overflow-y-auto p-6">
        {activeTab === 'battle' && (
          <div className="max-w-6xl mx-auto space-y-6">
            {/* Stage Info */}
            <div className="bg-slate-800 border-2 border-slate-700 rounded-lg p-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <Award className="text-amber-400" size={24} />
                  <span className="text-xl font-bold">Ïä§ÌÖåÏù¥ÏßÄ {currentStage}</span>
                </div>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={autoProgress}
                    onChange={(e) => setAutoProgress(e.target.checked)}
                    className="w-5 h-5"
                  />
                  <span className="text-sm">ÏûêÎèô ÏßÑÌñâ</span>
                </label>
              </div>
            </div>

            {/* Battle Area */}
            <div className="grid grid-cols-2 gap-6">
              {/* Knight */}
              <div className="bg-slate-800 border-2 border-blue-500 rounded-lg p-6">
                <div className="text-center mb-4">
                  <div className="text-6xl mb-2">üõ°Ô∏è</div>
                  <h3 className="text-xl font-bold text-blue-400">Ïã†ÏÑ±Ìïú Í∏∞ÏÇ¨</h3>
                  <div className="text-sm text-slate-400">Lv.{knight.level}</div>
                </div>
                
                <div className="space-y-2">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="flex items-center gap-1">
                        <Heart size={14} className="text-red-400" />
                        Ï≤¥Î†•
                      </span>
                      <span>{knight.hp} / {knight.maxHp}</span>
                    </div>
                    <div className="bg-slate-700 rounded-full h-3 overflow-hidden">
                      <div 
                        className="bg-red-500 h-full transition-all"
                        style={{ width: `${(knight.hp / knight.maxHp) * 100}%` }}
                      />
                    </div>
                  </div>
                  
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span>Í≤ΩÌóòÏπò</span>
                      <span>{knight.exp} / {knight.expToNext}</span>
                    </div>
                    <div className="bg-slate-700 rounded-full h-2 overflow-hidden">
                      <div 
                        className="bg-amber-400 h-full transition-all"
                        style={{ width: `${(knight.exp / knight.expToNext) * 100}%` }}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2 mt-4 text-sm">
                    <div className="bg-slate-700 rounded p-2">
                      <div className="text-slate-400">Í≥µÍ≤©Î†•</div>
                      <div className="font-bold text-orange-400">{knight.damage}</div>
                    </div>
                    <div className="bg-slate-700 rounded p-2">
                      <div className="text-slate-400">ÏπòÎ™ÖÌÉÄÏú®</div>
                      <div className="font-bold text-purple-400">{knight.critChance}%</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Monster */}
              <div className="bg-slate-800 border-2 border-red-500 rounded-lg p-6">
                {monster ? (
                  <>
                    <div className="text-center mb-4">
                      <div className="text-6xl mb-2">{monster.isBoss ? 'üëπ' : 'üòà'}</div>
                      <h3 className="text-xl font-bold text-red-400">{monster.name}</h3>
                      {monster.isBoss && <div className="text-xs text-amber-400">‚òÖ BOSS ‚òÖ</div>}
                    </div>
                    
                    <div className="space-y-2">
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="flex items-center gap-1">
                            <Heart size={14} className="text-red-400" />
                            Ï≤¥Î†•
                          </span>
                          <span>{Math.max(0, monster.hp)} / {monster.maxHp}</span>
                        </div>
                        <div className="bg-slate-700 rounded-full h-3 overflow-hidden">
                          <div 
                            className="bg-red-500 h-full transition-all"
                            style={{ width: `${(monster.hp / monster.maxHp) * 100}%` }}
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-2 mt-4 text-sm">
                        <div className="bg-slate-700 rounded p-2">
                          <div className="text-slate-400">Í≥µÍ≤©Î†•</div>
                          <div className="font-bold text-red-400">{monster.damage}</div>
                        </div>
                        <div className="bg-slate-700 rounded p-2">
                          <div className="text-slate-400">Î≥¥ÏÉÅ</div>
                          <div className="font-bold text-yellow-400">{monster.goldReward}G</div>
                        </div>
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="flex items-center justify-center h-full text-slate-500">
                    Îã§Ïùå Ï†Å ÏÉùÏÑ± Ï§ë...
                  </div>
                )}
              </div>
            </div>

            {/* Skills */}
            <div className="bg-slate-800 border-2 border-slate-700 rounded-lg p-4">
              <h3 className="font-bold mb-3 flex items-center gap-2">
                <Zap className="text-yellow-400" />
                Ïä§ÌÇ¨
              </h3>
              <div className="grid grid-cols-3 gap-3">
                {Object.entries(skills).map(([key, skill]) => (
                  <button
                    key={key}
                    onClick={() => useSkill(key)}
                    disabled={skill.level === 0 || skill.cooldown > 0}
                    className={`p-3 rounded border-2 transition-all ${
                      skill.level === 0
                        ? 'bg-slate-700 border-slate-600 text-slate-500 cursor-not-allowed'
                        : skill.cooldown > 0
                        ? 'bg-slate-700 border-slate-600 cursor-not-allowed'
                        : 'bg-slate-700 border-purple-500 hover:bg-purple-900 cursor-pointer'
                    }`}
                  >
                    <div className="font-bold text-sm">{key}</div>
                    <div className="text-xs text-slate-400">Lv.{skill.level}</div>
                    {skill.cooldown > 0 && (
                      <div className="text-xs text-amber-400 mt-1">{skill.cooldown}Ï¥à</div>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Battle Log */}
            <div className="bg-slate-800 border-2 border-slate-700 rounded-lg p-4">
              <h3 className="font-bold mb-2">Ï†ÑÌà¨ Î°úÍ∑∏</h3>
              <div className="space-y-1 text-sm font-mono">
                {battleLog.map((log, i) => (
                  <div key={i} className="text-slate-300">{log}</div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'upgrade' && (
          <div className="max-w-4xl mx-auto space-y-4">
            {Object.entries(upgrades).map(([key, upgrade]) => (
              <div key={key} className="bg-slate-800 border-2 border-slate-700 rounded-lg p-4">
                <div className="flex justify-between items-center">
                  <div className="flex-1">
                    <h3 className="font-bold text-lg capitalize flex items-center gap-2">
                      {key === 'weapon' && <Sword className="text-orange-400" size={20} />}
                      {key === 'armor' && <Shield className="text-blue-400" size={20} />}
                      {key === 'crit' && <Star className="text-purple-400" size={20} />}
                      {key === 'blessing' && <Crown className="text-amber-400" size={20} />}
                      {key}
                    </h3>
                    <div className="text-sm text-slate-400">Î†àÎ≤® {upgrade.level}</div>
                  </div>
                  <button
                    onClick={() => buyUpgrade(key)}
                    disabled={knight.gold < upgrade.cost}
                    className={`px-6 py-2 rounded font-bold transition-all ${
                      knight.gold < upgrade.cost
                        ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                        : 'bg-amber-600 hover:bg-amber-700 text-white'
                    }`}
                  >
                    {upgrade.cost} Í≥®Îìú
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'skills' && (
          <div className="max-w-4xl mx-auto space-y-4">
            {Object.entries(skills).map(([key, skill]) => (
              <div key={key} className="bg-slate-800 border-2 border-slate-700 rounded-lg p-4">
                <div className="flex justify-between items-center">
                  <div className="flex-1">
                    <h3 className="font-bold text-lg capitalize">{key}</h3>
                    <div className="text-sm text-slate-400">
                      Î†àÎ≤® {skill.level} | Ïø®Îã§Ïö¥: {skill.maxCooldown}Ï¥à
                    </div>
                  </div>
                  <button
                    onClick={() => buySkill(key)}
                    disabled={knight.gold < skill.cost}
                    className={`px-6 py-2 rounded font-bold transition-all ${
                      knight.gold < skill.cost
                        ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                        : 'bg-purple-600 hover:bg-purple-700 text-white'
                    }`}
                  >
                    {skill.cost} Í≥®Îìú
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'stats' && (
          <div className="max-w-4xl mx-auto space-y-6">
            <div className="bg-slate-800 border-2 border-slate-700 rounded-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                <TrendingUp className="text-green-400" />
                ÌÜµÍ≥Ñ
              </h2>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-700 rounded p-4">
                  <div className="text-slate-400 text-sm">Ï¥ù Ï≤òÏπò</div>
                  <div className="text-2xl font-bold text-red-400">{stats.totalKills}</div>
                </div>
                <div className="bg-slate-700 rounded p-4">
                  <div className="text-slate-400 text-sm">Ï¥ù ÌöçÎìù Í≥®Îìú</div>
                  <div className="text-2xl font-bold text-yellow-400">{stats.totalGold}</div>
                </div>
                <div className="bg-slate-700 rounded p-4">
                  <div className="text-slate-400 text-sm">ÏµúÍ≥† Ïä§ÌÖåÏù¥ÏßÄ</div>
                  <div className="text-2xl font-bold text-purple-400">{stats.highestStage}</div>
                </div>
                <div className="bg-slate-700 rounded p-4">
                  <div className="text-slate-400 text-sm">ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ</div>
                  <div className="text-2xl font-bold text-blue-400">{Math.floor(stats.playTime / 60)}Î∂Ñ</div>
                </div>
              </div>
            </div>

            <div className="bg-slate-800 border-2 border-slate-700 rounded-lg p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                <Award className="text-amber-400" />
                ÏóÖÏ†Å
              </h2>
              <div className="space-y-3">
                {achievements.map(ach => (
                  <div 
                    key={ach.id}
                    className={`p-4 rounded border-2 ${
                      ach.completed 
                        ? 'bg-amber-900 border-amber-500' 
                        : 'bg-slate-700 border-slate-600'
                    }`}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <h3 className="font-bold">{ach.name}</h3>
                        <p className="text-sm text-slate-400">{ach.desc}</p>
                      </div>
                      <div className="text-right">
                        {ach.completed ? (
                          <span className="text-amber-400 font-bold">‚úì ÏôÑÎ£å</span>
                        ) : (
                          <span className="text-yellow-400 font-bold">+{ach.reward}G</span>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
